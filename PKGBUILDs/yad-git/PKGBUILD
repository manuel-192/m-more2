#!/bin/bash

# Maintainer: manuel (see forum.endeavouros.com)
# Maintainer: Christian Hesse <mail@eworm.de>
# Contributor: Aaron Fischer <mail@aaron-fischer.net>
# Contributor: Steven Allen <steven@stebalien.com>
# Contributor: trile7 at gmail dot com
# Contributor: Ernia <monghitri@aruba.it>

# Latest yad with fixes.

pkgname=yad-git
pkgver=9.1.git33f526f
pkgrel=1.1
pkgdesc='A fork of zenity - display graphical dialogs from shell scripts or command line'
url='https://github.com/v1cont/yad'
arch=('x86_64')
license=('GPL3')
depends=('gtk3' 'webkit2gtk' 'gtkspell3')
makedepends=('autoconf' 'automake' 'intltool')
source=( git+${url}.git )
sha256sums=( SKIP )
provides=(yad)
conflicts=(yad yad-git)

pkgver() {
  cd yad

  if [ 0 -eq 1 ] ; then
      printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
  else
      local release="$(grep AC_INIT configure.ac | awk '{print $2}' | sed -e 's|^.||' -e 's|..$||')"
      local commit="$(git rev-parse --short HEAD)"
      echo "$release.git$commit"
  fi
}

prepare() {
    local file=yad/src/main.c
    local add_before_this_line="parse_geometry ();"         # line number 567 in version 9.0!
    local pp="gtk_widget_set_size_request (dlg, nw, -1);"   # check with this string if this patch already exists
    local patch=""
    local color_red="$(printf "\e[1;35m")"
    local color_reset="$(printf "\e[0m")"

    if [ "$(grep "$pp" $file)" = "" ] ; then
        echo "${color_red}====>${color_reset} $pkgname: patching $file" >&2

        patch+="     gint mw, nw;\n\n"
        patch+="      gtk_widget_get_preferred_width (dlg, &mw, &nw);\n"
        patch+="      $pp\n"

        sed -i $file -e "/$add_before_this_line/i \ $patch"
    fi
}

build() {
  cd yad

  autoreconf -ivf
  intltoolize
  ./configure \
    --prefix=/usr \
    --enable-icon-browser \
    --enable-html \
    --enable-gio \
    --enable-spell \
    --enable-sourceview

  make
}

package() {
  cd yad

  make DESTDIR="${pkgdir}" install

  cd ../..
  rm -rf yad
}
